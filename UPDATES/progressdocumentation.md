# Progress Documentation for Lavanya-TTS Deployment

## 1. Project Overview
Lavanya-TTS is a multilingual text-to-speech (TTS) web application supporting multiple Indian languages and genders. The backend is based on ESPnet FastSpeech2 and HiFi-GAN, and the frontend is a web interface for user interaction and audio playback.

---

## 2. Key Issues Faced & Solutions

### 2.1 Backend-Frontend Integration
- **Issue:** Frontend needed to play audio generated by backend.
- **Solution:** Backend returns JSON with audio file path; frontend sets <audio> source from this. No backend change needed.

### 2.2 Timeout & Concurrency
- **Issue:** Flask/Gunicorn timeouts and concurrency errors, especially on Render free tier.
- **Solution:** Replaced signal-based timeouts with ThreadPoolExecutor. Reduced Gunicorn workers/threads, added input limits and file cleanup.

### 2.3 Resource Optimization
- **Issue:** Render free tier (512MB RAM, shared CPU) caused slow inference and timeouts.
- **Solution:** Reduced input text length, optimized model loading, garbage collection, and file cleanup. Recommended upgrading to paid plans for better resources.

### 2.4 Git LFS & Model Files
- **Issue:** Git LFS quota issues and missing files in Docker builds.
- **Solution:** Only track large files (model.pth, config.yaml if large) with LFS. Store small stats files as regular files. Always run `git lfs pull` before Docker build. Do not use `RUN git lfs pull` in Dockerfile.

### 2.5 Deployment Config
- **Issue:** Port errors, missing dependencies, and permission issues.
- **Solution:** Fixed Gunicorn config, added missing packages (e.g., flask_cors), set correct permissions (644 for files, 777 for tmp/static/audio).

---

## 3. Path Handling & Model Files

### 3.1 Config.yaml Best Practices
- Use only the filename for `stats_file` entries (e.g., `feats_stats.npz`), not a path.
- Patch config.yaml at runtime to use absolute paths before loading with ESPnet.

### 3.2 File Tracking
- Track only large files with Git LFS.
- Untrack small files and commit as regular files.
- Use `git add -f` for files ignored by .gitignore.

### 3.3 Permissions
- All model, stats, and dictionary files: 644
- Output/temp directories (tmp, static/audio): 777

---

## 4. Deployment Steps (Render/DigitalOcean)

1. Ensure all required model files are present for each supported language/gender.
2. Run `git lfs pull` locally before building Docker images.
3. Build and deploy Docker image (do not use `RUN git lfs pull` in Dockerfile).
4. After deployment, verify file hashes and test file loading in the container:
   - `md5sum /app/Fastspeech2_HS/<lang>/<gender>/model/feats_stats.npz`
   - `python3 -c "import numpy as np; np.load('/app/Fastspeech2_HS/<lang>/<gender>/model/feats_stats.npz', allow_pickle=False)"`
5. Test API/web app end-to-end.
6. Monitor logs for errors/timeouts.

---

## 5. Performance & Reliability

- Load models and vocoders once at startup, not per request.
- Limit input text length to avoid timeouts.
- Upgrade to higher resource plans if needed.
- Use background jobs for long-running inference if scaling.

---

## 6. Troubleshooting Table

| Error/Issue                                 | Cause                        | Solution                                 |
|---------------------------------------------|------------------------------|------------------------------------------|
| ValueError: pickled data                    | .npz saved with pickle       | Re-save as plain NumPy arrays            |
| FileNotFoundError: feats_stats.npz          | Wrong path or missing file   | Check config, ensure file is present     |
| SIGKILL (exit code 137/9)                   | Out of memory/CPU            | Upgrade plan, optimize model             |
| Request timed out                           | Inference too slow           | Limit input, load models at startup      |
| Unexpected end of JSON input                | Timeout/incomplete response  | Optimize backend, upgrade plan           |
| ModuleNotFoundError: flask_cors             | Missing dependency           | Add to requirements.txt                  |

---

## 7. Checklist for Adding a New Language/Gender

- [x] Place all required files (`model.pth`, `config.yaml`, `feats_stats.npz`, `energy_stats.npz`, `pitch_stats.npz`) in the correct model directory.
- [x] Ensure all `.npz` stats files are plain NumPy arrays (not pickled).
- [x] Track only large files with LFS; commit small files as regular files.
- [x] Use only the filename for `stats_file` in config.yaml.
- [x] Set permissions: files to 644, output/temp dirs to 777.
- [x] Update backend logic to select the correct model directory.
- [x] Test after deployment: file hashes, np.load, inference, and audio output.

---

## 8. Key Learnings & Best Practices

- Use only the filename in config.yaml for portability.
- Patch config.yaml at runtime to use absolute paths.
- Do not use `RUN git lfs pull` in Dockerfile; always run `git lfs pull` locally before build.
- Only track large files with LFS; use regular Git for small files.
- Always check file hashes and test file loading after deployment.
- Monitor logs for errors and optimize for your deployment environment.

---

## 9. Next Steps

- Add more languages/genders as needed, following the checklist.
- Optimize for performance and scaling as usage grows.
- Document any new issues and solutions in this file for future reference.

---

# =====================
# DETAILED COMMANDS & CHECKLIST FOR MODEL FILES, LFS, AND DEPLOYMENT
# =====================

## 1. Git LFS Tracking and Adding Large Files

# Track large model files with LFS
# (Do this once for each new model file)
git lfs track "Fastspeech2_HS/marathi/male/model/model.pth"
git lfs track "Fastspeech2_HS/english/male/model/model.pth"
git lfs track "Fastspeech2_HS/hindi/male/model/model.pth"
git lfs track "Fastspeech2_HS/english/male/model/config.yaml"
git lfs track "Fastspeech2_HS/hindi/male/model/config.yaml"
git add .gitattributes

# Add large files (force if .gitignore blocks them)
git add -f Fastspeech2_HS/marathi/male/model/model.pth
# ...repeat for other .pth and large .yaml files...
git add -f Fastspeech2_HS/english/male/model/model.pth
# ...
git add -f Fastspeech2_HS/hindi/male/model/model.pth
# ...
git add -f Fastspeech2_HS/english/male/model/config.yaml
# ...
git add -f Fastspeech2_HS/hindi/male/model/config.yaml

## 2. Add Small Stats Files as Regular Files

git add Fastspeech2_HS/marathi/male/model/feats_stats.npz
# ...repeat for all .npz files for each language/gender...
git add Fastspeech2_HS/english/male/model/feats_stats.npz
git add Fastspeech2_HS/english/male/model/energy_stats.npz
git add Fastspeech2_HS/english/male/model/pitch_stats.npz
git add Fastspeech2_HS/hindi/male/model/feats_stats.npz
git add Fastspeech2_HS/hindi/male/model/energy_stats.npz
git add Fastspeech2_HS/hindi/male/model/pitch_stats.npz

## 3. Commit and Push

git commit -m "Track model.pth and config.yaml with LFS; add stats files as regular files for all models"
git push origin main

## 4. Verify LFS Tracking

git lfs ls-files

## 5. Permissions (run in shell)

chmod 644 Fastspeech2_HS/english/male/model/*
chmod 644 Fastspeech2_HS/hindi/male/model/*
chmod 777 Fastspeech2_HS/tmp
chmod 777 static/audio

## 6. Check File Hashes and Loading (local and after deployment)

md5sum Fastspeech2_HS/english/male/model/feats_stats.npz
md5sum Fastspeech2_HS/hindi/male/model/feats_stats.npz
# After deployment, in container:
md5sum /app/Fastspeech2_HS/english/male/model/feats_stats.npz
md5sum /app/Fastspeech2_HS/hindi/male/model/feats_stats.npz

python3 -c "import numpy as np; np.load('/app/Fastspeech2_HS/english/male/model/feats_stats.npz', allow_pickle=False)"
python3 -c "import numpy as np; np.load('/app/Fastspeech2_HS/hindi/male/model/feats_stats.npz', allow_pickle=False)"

## 7. Checklist for Adding a New Language/Gender

- [x] Place all required files (`model.pth`, `config.yaml`, `feats_stats.npz`, `energy_stats.npz`, `pitch_stats.npz`) in the correct model directory.
- [x] Ensure all `.npz` stats files are plain NumPy arrays (not pickled).
- [x] Track only large files with LFS; commit small files as regular files.
- [x] Use only the filename for `stats_file` in config.yaml.
- [x] Set permissions: files to 644, output/temp dirs to 777.
- [x] Update backend logic to select the correct model directory.
- [x] Test after deployment: file hashes, np.load, inference, and audio output.

# =====================
# END OF DETAILED COMMANDS & CHECKLIST
# =====================

---

ðŸŽ‰ **Lavanya-TTS is now robust, portable, and ready for production and scaling!**
